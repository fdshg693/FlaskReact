# 04. テスト戦略

## 概要

本プロジェクトでは、開発効率を重視し、網羅的なテストは行わない。
ロジックが複雑な部分・コアな部分に集中してテストを追加する方針をとる。

---

## テスト方針

### 基本方針

- **網羅的なテストは不要**: 100%のカバレッジを目指さない
- **コア機能に集中**: ビジネスロジック、複雑な計算処理を優先
- **開発効率を重視**: テスト作成に過度な時間をかけない
- **手動確認も活用**: すべてを自動テストにする必要はない

### テスト対象の優先度

| 優先度 | 対象 | 例 |
|-------|------|-----|
| 高 | 複雑なビジネスロジック | 料金計算、スコアリング |
| 高 | データ変換処理 | パース、正規化、フォーマット変換 |
| 中 | ユーティリティ関数 | ファイル操作、文字列処理 |
| 低 | シンプルなCRUD | 単純なDB操作 |
| 不要 | 単純なプロパティ確認 | データクラスのフィールド存在確認 |

---

## ユニットテスト

### 対象

- 複雑な計算ロジックを持つ関数・メソッド
- エッジケースが存在する処理
- リファクタリング時に壊れやすい処理

### 対象外

- 単純なプロパティのgetter/setter
- 外部APIを直接呼び出すだけの関数（モックが複雑になる場合）
- UIの表示ロジック

### 書き方

```python
# tests/test_calculator.py
import pytest
from src.services.calculator import calculate_score

class TestCalculateScore:
    """calculate_score関数のテスト"""
    
    def test_normal_case(self):
        """正常系: 通常の入力に対する計算"""
        result = calculate_score([1.0, 2.0, 3.0], weight=2.0)
        assert result == 12.0
    
    def test_empty_list_raises_error(self):
        """異常系: 空リストでValueErrorが発生"""
        with pytest.raises(ValueError):
            calculate_score([], weight=1.0)
    
    def test_zero_weight(self):
        """エッジケース: weight=0の場合"""
        result = calculate_score([1.0, 2.0], weight=0.0)
        assert result == 0.0
```

### テストの配置

```
tests/
├── config/
│   └── test_paths.py
├── machineLearning/
│   └── test_dataset_converter.py
├── server/
│   └── test_app_smoke.py
└── conftest.py          # 共通のfixture
```

---

## 手動動作確認

### 方針

自動テストだけでなく、手動での動作確認も重要な検証手段として位置づける。

### 方法

#### 1. `__main__` ブロックの活用

各モジュールに動作確認用のコードを記述する。

```python
# src/services/iris_service.py

def predict(data: list[float]) -> str:
    """Irisの品種を予測する"""
    ...

if __name__ == "__main__":
    # 動作確認用
    test_data = [5.1, 3.5, 1.4, 0.2]
    result = predict(test_data)
    print(f"Prediction: {result}")
```

```bash
# 実行
python -m src.services.iris_service
```

#### 2. examples/ ディレクトリの活用

サービスの使い方を示すサンプルスクリプトを配置する。

```
examples/
├── iris_prediction.py     # Irisサービスの動作確認
├── image_processing.py    # 画像処理の動作確認
└── llm_chat.py           # LLMチャットの動作確認
```

#### 3. Jupyter Notebookの活用

インタラクティブな確認が必要な場合はNotebookを使用する。

---

## テスト実行

### コマンド

```bash
# 全テスト実行
pytest

# 特定のファイル
pytest tests/test_calculator.py

# 特定のテスト
pytest tests/test_calculator.py::TestCalculateScore::test_normal_case

# カバレッジ付き
pytest --cov=src --cov-report=html
```

### CI/CDでの実行

PRを出した際に自動でテストが実行される構成を推奨。

---