# 02. コーディング規約

## 概要

本規約は、コードの可読性・保守性を維持するための基本ルールを定める。
過度に厳格なルールは設けず、実用性を重視する。

---

## 一般規約

### コメント

- コードの意図が分かりにくい箇所にはコメントを付ける
- AIが生成した英語コメントはそのままでも可、余裕があれば日本語に翻訳する
- 自明なコードにはコメント不要（コメント過多も避ける）

```python
# Good: 意図を説明
# 外れ値を除去するため、3σ以上のデータを除外
filtered_data = data[data["value"] < mean + 3 * std]

# Bad: 自明なコメント
# iに1を足す
i = i + 1
```

### DocString

- 関数・クラスには必ずDocStringを記載する
- 引数・戻り値・例外の説明を含める
- Google Style または NumPy Style を推奨

```python
def calculate_score(data: list[float], weight: float = 1.0) -> float:
    """
    スコアを計算する。

    Args:
        data: 入力データのリスト
        weight: 重み係数（デフォルト: 1.0）

    Returns:
        計算されたスコア

    Raises:
        ValueError: dataが空の場合
    """
    if not data:
        raise ValueError("data cannot be empty")
    return sum(data) * weight
```

### 命名規則

| 対象 | 規則 | 例 |
|-----|------|-----|
| 変数・関数 | snake_case | `user_name`, `calculate_total()` |
| クラス | PascalCase | `UserModel`, `DataProcessor` |
| 定数 | UPPER_SNAKE_CASE | `MAX_RETRY_COUNT`, `API_BASE_URL` |
| プライベート | 先頭に`_` | `_internal_method()`, `_cache` |

- 意味のある名前を付ける（`x`, `tmp` などは避ける）
- 略語は一般的なもののみ使用（`url`, `api`, `db` など）

### 関数・クラスの設計

- 1つの関数は1つの責務のみを持つ（Single Responsibility）
- 長い関数は分割する（目安: 30行以上は分割を検討）
- 重複コードは共通化する

---

## Python固有規約

### 型アノテーション

- すべての関数に型アノテーションを付与する
- Python 3.10以降の記法を使用

```python
# Good: モダンな型アノテーション
def process_items(items: list[str]) -> dict[str, int]:
    return {item: len(item) for item in items}

# Bad: 古い記法
from typing import List, Dict
def process_items(items: List[str]) -> Dict[str, int]:
    ...
```

### モダンなライブラリ・記法の活用

| 用途 | 推奨 | 非推奨 |
|-----|------|-------|
| 文字列フォーマット | f-string | `.format()`, `%` |
| パス操作 | `pathlib.Path` | `os.path` |
| データクラス | `dataclass`, `pydantic` | 素のクラス |
| CLI引数 | `typer` | `argparse` |
| リッチ出力 | `rich` | `print` |
| 設定管理 | `pydantic-settings` | 素の`os.environ` |

```python
# Good
from pathlib import Path
config_path = Path(__file__).parent / "config.yaml"

# Bad
import os
config_path = os.path.join(os.path.dirname(__file__), "config.yaml")
```

### インポート順序

1. 標準ライブラリ
2. サードパーティライブラリ
3. ローカルモジュール

```python
# 標準ライブラリ
import json
from pathlib import Path

# サードパーティ
import pandas as pd
from pydantic import BaseModel

# ローカル
from src.config import settings
from src.utils import helpers
```

---

## リファクタリング方針

### 基本方針

- 定期的にコードを見直し、改善点があればリファクタリングを行う
- 後方互換性は基本的に考慮せず、徹底的に改善する
- 大規模な改善は一度にやらず、TODOコメントで残して段階的に実施

### TODOコメントの書き方

#### コメントの種類

| マーカー | 用途 |
|---------|------|
| `TODO` | 将来的に実装したい機能 |
| `FIXME` | 動作はするが修正が必要な問題 |
| `HACK` | 暫定的な実装（後でリファクタリング必要） |
| `XXX` | 重大な問題、すぐに対応が必要 |
| `NOTE` | 重要な説明や注意事項 |
| `OPTIMIZE` | パフォーマンス改善の余地 |

#### 書き方の例

```python
# TODO: 型アノテーションを追加する
# Priority: Medium
# Assignee: @maikuma

# FIXME: 大量データで遅くなる問題
# Priority: High
# See: https://github.com/xxx/issues/123

# HACK: APIの仕様変更までの暫定対応
# Remove after: 2024-12
def workaround_function():
    ...
```

---