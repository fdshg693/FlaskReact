# アプリケーション実行方法

このドキュメントでは、FlaskとStreamlitアプリケーションの実行方法、デバッグ方法を説明します。

---

## 🚀 Flask アプリケーション

### 基本的な起動方法

```bash
uv run src/flask_entry.py
```

**アクセス先**: `http://localhost:8000`

### デバッグモードでの起動

```bash
# 環境変数でデバッグモード有効化
FLASK_DEBUG=1 uv run src/flask_entry.py
```

または、VSCodeのデバッグ機能を使用（後述）。

### ポート変更

デフォルトは8000番ポートですが、変更する場合：

```bash
# 環境変数で指定
FLASK_PORT=5000 uv run src/flask_entry.py
```

または、`src/flask_entry.py` を編集：

```python
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000, debug=True)  # ポート番号を変更
```

---

## 🎨 Streamlit アプリケーション

### 基本的な起動方法

```bash
uv run streamlit run src/server/streamlit/agent_app.py --server.port=8501
```

**アクセス先**: `http://localhost:8501`

### その他のオプション

```bash
# ブラウザを自動で開かない
uv run streamlit run src/server/streamlit/agent_app.py --server.port=8501 --server.headless=true

# ファイル変更時に自動リロード（デフォルトで有効）
uv run streamlit run src/server/streamlit/agent_app.py --server.runOnSave=true
```

---

## 🐛 VSCode デバッグ機能

### 1. デバッグ構成

`.vscode/launch.json` に以下のデバッグ構成が定義されています：

#### Flask App

```json
{
  "name": "Flask App",
  "type": "debugpy",
  "request": "launch",
  "program": "${workspaceFolder}/src/flask_entry.py",
  "console": "integratedTerminal",
  "justMyCode": false,
  "env": {
    "FLASK_DEBUG": "1"
  }
}
```

#### Streamlit App

```json
{
  "name": "Streamlit App",
  "type": "debugpy",
  "request": "launch",
  "module": "streamlit",
  "args": [
    "run",
    "${workspaceFolder}/src/server/streamlit/agent_app.py",
    "--server.port=8501"
  ],
  "console": "integratedTerminal",
  "justMyCode": false
}
```

#### Current Python File

```json
{
  "name": "Python: Current File",
  "type": "debugpy",
  "request": "launch",
  "program": "${file}",
  "console": "integratedTerminal",
  "justMyCode": true
}
```

### 2. デバッグの開始

1. VSCodeでデバッグしたいファイルを開く
2. ブレークポイントを設定（行番号の左をクリック）
3. F5キーを押す、または左サイドバーの「実行とデバッグ」から構成を選択
4. 実行が一時停止したら、変数の値を確認したり、ステップ実行を行う

### 3. デバッグコンソールの活用

デバッグ中に、デバッグコンソールで式を評価できます：

```python
# 変数の値を確認
print(variable_name)

# 式を評価
len(my_list)

# オブジェクトの属性を確認
vars(my_object)
```

---

## 📊 ログの確認

### ログの出力先

アプリケーションは `loguru` を使用してログを出力します。

- **コンソール**: 標準出力に表示
- **ファイル**: `logs/` フォルダ配下に保存（設定されている場合）

### ログレベルの変更

`.env` ファイルでログレベルを設定：

```env
LOG_LEVEL=DEBUG  # DEBUG, INFO, WARNING, ERROR, CRITICAL
```

### ログの例

```python
from loguru import logger

logger.debug("デバッグ情報")
logger.info("情報メッセージ")
logger.warning("警告メッセージ")
logger.error("エラーメッセージ")
logger.critical("致命的なエラー")
```

---

## 🌐 エンドポイント一覧

### Flask アプリケーション

主要なエンドポイント：

| エンドポイント | 説明 | メソッド |
|-------------|------|---------|
| `/` | ホームページ | GET |
| `/home` | ホーム画面 | GET |
| `/csvTest` | CSV処理画面 | GET |
| `/image` | 画像処理画面 | GET |
| `/api/iris/predict` | Iris予測API | POST |
| `/api/image/process` | 画像処理API | POST |
| `/api/pdf/extract` | PDF抽出API | POST |

詳細は `src/server/flask_react_app/` のルート定義を参照してください。

### APIの使用例

#### Iris予測

```bash
curl -X POST http://localhost:8000/api/iris/predict \
  -H "Content-Type: application/json" \
  -d '{
    "sepal_length": 5.1,
    "sepal_width": 3.5,
    "petal_length": 1.4,
    "petal_width": 0.2
  }'
```

#### 画像処理

```bash
curl -X POST http://localhost:8000/api/image/process \
  -F "image=@/path/to/image.jpg" \
  -F "operation=grayscale"
```

---

## 🧪 テストの実行

### すべてのテストを実行

```bash
uv run pytest
```

### 特定のテストファイルを実行

```bash
uv run pytest tests/server/test_app_smoke.py
```

### カバレッジ付きで実行

```bash
uv run pytest --cov=src --cov-report=html
```

カバレッジレポートは `htmlcov/index.html` で確認できます。

### 詳細モード

```bash
# より詳細な出力
uv run pytest -v

# 簡潔な出力
uv run pytest -q

# 失敗したテストのみ再実行
uv run pytest --lf
```

---

## 🔄 開発中の便利な機能

### 自動リロード

Flaskは開発モードで自動リロードが有効です。ファイルを変更すると自動的にサーバーが再起動します。

```python
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000, debug=True)  # debug=True
```

Streamlitもデフォルトで自動リロードが有効です。

### ホットリロード

フロントエンド（React/JS）の変更は、ブラウザをリロードするだけで反映されます。

---

## 🚦 複数アプリを同時起動

Flask と Streamlit を同時に起動する場合は、それぞれ別のターミナルで実行します。

**ターミナル1（Flask）:**
```bash
uv run src/flask_entry.py
```

**ターミナル2（Streamlit）:**
```bash
uv run streamlit run src/server/streamlit/agent_app.py --server.port=8501
```

VSCodeの分割ターミナル機能が便利です：
- `Cmd+Shift+5` (macOS) / `Ctrl+Shift+5` (Windows/Linux)

---

## 🛑 アプリケーションの停止

### ターミナルから起動した場合

`Ctrl+C` でプロセスを停止します。

### VSCodeデバッグから起動した場合

1. デバッグツールバーの停止ボタン（赤い四角）をクリック
2. または `Shift+F5`

### バックグラウンドプロセスの確認

```bash
# Flaskのプロセスを確認
ps aux | grep flask_entry.py

# プロセスを強制終了
kill -9 <PID>

# ポート8000を使用しているプロセスを確認
lsof -i :8000

# ポート8000を使用しているプロセスを強制終了
lsof -ti :8000 | xargs kill -9
```

---

## 🐛 トラブルシューティング

### ポートが既に使用されている

```
Error: Address already in use
```

**解決方法:**

1. 使用中のプロセスを確認・終了
   ```bash
   lsof -ti :8000 | xargs kill -9
   ```

2. 別のポートを使用
   ```bash
   FLASK_PORT=5000 uv run src/flask_entry.py
   ```

### モジュールが見つからない

```
ModuleNotFoundError: No module named 'xxx'
```

**解決方法:**

```bash
# 依存関係を再インストール
uv sync

# 仮想環境を再作成
rm -rf .venv
uv sync
```

### APIキーエラー

```
Error: ANTHROPIC_API_KEY not found
```

**解決方法:**

`.env` ファイルにAPIキーが正しく設定されているか確認：

```bash
cat .env | grep API_KEY
```

### データファイルが見つからない

```
FileNotFoundError: [Errno 2] No such file or directory
```

**解決方法:**

1. 必要なデータファイルが `data/original_sources/` に配置されているか確認
2. パス設定が正しいか `src/config/paths.py` を確認

---

## 📚 次のステップ

アプリケーションが正常に起動できたら、次のドキュメントを確認してください：

1. **スクリプト活用**: [04_スクリプト・ツール活用.md](./04_スクリプト・ツール活用.md)
2. **AI活用**: [05_AI活用・自動化.md](./05_AI活用・自動化.md)
3. **コーディング規約**: [../dev_contract/02_コーディング規約.md](../dev_contract/02_コーディング規約.md)
