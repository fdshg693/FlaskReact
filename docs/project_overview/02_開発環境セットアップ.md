# 開発環境セットアップ

このドキュメントでは、開発環境の構築手順を説明します。

---

## 📋 前提条件

### 必須
- **Python 3.13以上**
- **uv**: Python依存関係管理ツール
  ```bash
  # macOS/Linux
  curl -LsSf https://astral.sh/uv/install.sh | sh
  
  # Windows
  powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
  ```

### 推奨
- **VSCode**: 推奨エディタ
- **Git**: バージョン管理

---

## 🚀 セットアップ手順

### 1. リポジトリのクローン

```bash
git clone <repository-url>
cd FlaskReact
```

### 2. 依存関係のインストール

```bash
uv sync
```

これにより以下が実行されます：
- 仮想環境の作成 (`.venv/`)
- `pyproject.toml`に基づく依存パッケージのインストール

### 3. 設定ファイルの作成

#### 環境変数（`.env`）

```bash
cp .env.example .env
```

`.env`ファイルを編集して、以下の情報を設定：

```env
# LLM API Keys
ANTHROPIC_API_KEY=your_anthropic_api_key_here
OPENAI_API_KEY=your_openai_api_key_here

# その他の設定
LOG_LEVEL=INFO
```

#### 機械学習設定ファイル

MLモデルの設定ファイルを作成：

```bash
# 例: src/ml/配下の.yaml.exampleをコピー
cp src/ml/config.yaml.example src/ml/config.yaml
```

必要に応じて設定を編集してください。

---

## 🔧 VSCode設定

### 1. 設定ファイルのコピー

`.vscode/`フォルダ内のサンプルファイルをコピーして使用します：

```bash
cp .vscode/settings.json.example .vscode/settings.json
cp .vscode/launch.json.example .vscode/launch.json
cp .vscode/tasks.json.example .vscode/tasks.json
```

### 2. 推奨拡張機能のインストール

VSCodeを開くと、推奨拡張機能のインストールを促されます。以下の拡張機能が推奨されます：

- **Python**: Python言語サポート
- **Pylance**: Python型チェック
- **Ruff**: Python リント・フォーマット
- **GitHub Copilot**: AI支援コーディング
- **Prettier**: コードフォーマッター
- **ESLint**: JavaScript/TypeScript リント

または、コマンドパレット（`Cmd+Shift+P` / `Ctrl+Shift+P`）から：
```
Extensions: Show Recommended Extensions
```

### 3. 主要な設定内容

#### `settings.json`
- **Python環境**: `.venv/`の仮想環境を自動認識
- **リント/フォーマット**: Ruffを使用
- **型チェック**: mypyを有効化
- **自動保存**: ファイル保存時に自動フォーマット

```json
{
  "python.defaultInterpreterPath": "${workspaceFolder}/.venv/bin/python",
  "[python]": {
    "editor.defaultFormatter": "charliermarsh.ruff",
    "editor.formatOnSave": true,
    "editor.codeActionsOnSave": {
      "source.fixAll": "explicit",
      "source.organizeImports": "explicit"
    }
  },
  "python.analysis.typeCheckingMode": "basic",
  "mypy.dmypyExecutable": "${workspaceFolder}/.venv/bin/dmypy"
}
```

#### `launch.json`
デバッグ構成が定義されています：

- **Flask App**: Flaskアプリケーションのデバッグ起動
- **Streamlit App**: Streamlitアプリのデバッグ起動
- **Current Python File**: 現在開いているPythonファイルを実行

**使い方**: F5キーでデバッグ開始

#### `tasks.json`
便利なタスクが定義されています：

- **Run Tests**: pytestを実行
- **Format Code**: Ruffでコードフォーマット
- **Type Check**: mypyで型チェック

**使い方**: `Cmd+Shift+P` → `Tasks: Run Task`

---

## 🧪 動作確認

### 1. テストの実行

```bash
uv run pytest -q
```

すべてのテストがパスすることを確認してください。

### 2. Flaskアプリの起動

```bash
uv run src/flask_entry.py
```

ブラウザで `http://localhost:8000` にアクセスして、アプリが正常に起動することを確認。

### 3. Streamlitアプリの起動（任意）

```bash
uv run streamlit run src/server/streamlit/agent_app.py --server.port=8501
```

ブラウザで `http://localhost:8501` にアクセス。

---

## 🛠️ 開発ツールの設定

### pre-commitの設定

コミット前に自動チェックを実行するためのフックを設定：

```bash
uv run pre-commit install
```

これにより、コミット時に以下が自動実行されます：
- コードフォーマット (Ruff)
- リント (Ruff)
- 型チェック (mypy)
- トレイリングスペースの削除
- ファイル末尾の改行チェック

設定内容は `.pre-commit-config.yaml` を参照してください。

### Git設定

```bash
# ユーザー情報の設定（初回のみ）
git config user.name "Your Name"
git config user.email "your.email@example.com"

# デフォルトブランチの確認
git branch  # 現在: maikuma, デフォルト: dev
```

Git運用の詳細は [../dev_contract/06_Git運用.md](../dev_contract/06_Git運用.md) を参照してください。

---

## 📦 依存関係の管理

### パッケージの追加

```bash
# 本番用パッケージ
uv add <package-name>

# 開発用パッケージ
uv add --dev <package-name>
```

### 依存関係の更新

```bash
# すべてのパッケージを更新
uv sync --upgrade

# 特定のパッケージを更新
uv add --upgrade <package-name>
```

### 依存関係の確認

```bash
# インストール済みパッケージ一覧
uv pip list

# 依存関係ツリー
uv pip tree
```

---

## 🐛 トラブルシューティング

### 仮想環境が認識されない

```bash
# 仮想環境を削除して再作成
rm -rf .venv
uv sync
```

VSCodeを再起動して、Pythonインタープリタを再選択してください。

### パッケージのインストールエラー

```bash
# uvのアップデート
uv self update

# キャッシュをクリア
uv cache clean
```

### 型チェックエラーが多い

`mypy.ini` または `pyproject.toml` の設定を確認してください。
開発初期は型チェックを緩めに設定することも検討してください。

### pre-commitが失敗する

```bash
# フックを再インストール
uv run pre-commit uninstall
uv run pre-commit install

# すべてのファイルに対して手動実行
uv run pre-commit run --all-files
```

---

## 📚 次のステップ

環境構築が完了したら、次のドキュメントを確認してください：

1. **アプリケーション実行**: [03_アプリケーション実行方法.md](./03_アプリケーション実行方法.md)
2. **スクリプト活用**: [04_スクリプト・ツール活用.md](./04_スクリプト・ツール活用.md)
3. **コーディング規約**: [../dev_contract/02_コーディング規約.md](../dev_contract/02_コーディング規約.md)
