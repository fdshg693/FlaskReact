# AI活用・自動化ガイド

このドキュメントでは、GitHub Copilot、AIレビュー、その他の自動化の仕組みについて説明します。

---

## 🤖 GitHub Copilot の活用

### 概要

本プロジェクトでは、GitHub Copilot の以下の機能を活用しています：

1. **エージェント（Agents）**: 特定の役割を持つAIアシスタント
2. **プロンプト（Prompts）**: 特定のタスクに特化したテンプレート
3. **タスク（Tasks）**: エージェントが実行するタスクの定義

### エージェントの使い方

#### 利用可能なエージェント

エージェントは `.github/agents/` に定義されています：

```
.github/agents/
├── coder.script.default.agent.md      # スクリプト生成
├── docs.ai_knowledge.default.agent.md # AIナレッジドキュメント作成
├── docs.readme.default.agent.md       # README作成
├── docs.review.default.agent.md       # ドキュメントレビュー
└── general.basic.default.agent.md     # 汎用エージェント
```

#### エージェントの呼び出し方

1. **GitHub Copilot Chat を開く**
   - VSCode: サイドバーのCopilotアイコン
   - ショートカット: `Cmd+Shift+I` (macOS) / `Ctrl+Shift+I` (Windows/Linux)

2. **エージェントを選択**
   - チャット画面上部のドロップダウンから選択

### プロンプトの使い方

#### 利用可能なプロンプト

プロンプトは `.github/prompts/` に定義されています。

#### プロンプトの呼び出し方

1. **スラッシュコマンドで呼び出し**
   - チャット画面で `/` を入力
   - 候補から選択

2. **例**:
   ```
   /review-code
   ```

---

## 🔍 AIレビューの実施方法

コード品質を定期的に確認するため、複数の方法でAIレビューを実施できます。

### 1. GitHub Copilot を使ったレビュー

#### インタラクティブレビュー

1. レビューしたいコードを選択
2. Copilot Chat を開く
3. 以下のような指示を入力：
   ```
   このコードをレビューして、改善点を教えてください。
   特に以下の観点でチェック：
   - コーディング規約の遵守
   - パフォーマンス
   - セキュリティ
   - 可読性
   ```

#### エージェントを使ったレビュー

```
@docs.review src/server/flask_entry.py をレビューしてください
```

### 2. GitHub Copilot CLI を使った並列レビュー

大規模なコードベースを効率的にレビューするため、並列実行機能を使用します。

#### YAML設定ファイルの作成

`scripts/github_copilot/cli/config/review.yml` を作成：

```yaml
tasks:
  - folder: src/llm
    instruction: |
      LLMモジュールのコードレビューを実施。
      以下の観点でチェック：
      - APIキーの適切な管理
      - エラーハンドリング
      - ログ出力の適切性
    output: logs/copilot_review/llm_review.md
  
  - folder: src/ml
    instruction: |
      MLモジュールのコードレビューを実施。
      以下の観点でチェック：
      - データ前処理の妥当性
      - モデルの保存/読み込み
      - 型アノテーションの完備
    output: logs/copilot_review/ml_review.md
  
  - folder: src/server
    instruction: |
      サーバーモジュールのコードレビューを実施。
      以下の観点でチェック：
      - ルーティングの適切性
      - セキュリティ対策
      - エラーレスポンスの統一性
    output: logs/copilot_review/server_review.md
```

#### レビューの実行

```bash
bash scripts/github_copilot/cli/scripts.sh scripts/github_copilot/cli/config/review.yml
```

**メリット:**
- コンテキストを限定することで精度向上
- 並列実行による高速化
- レビュー結果を個別ファイルとして保存

### 3. PR ベースのレビュー

#### GitHub Actions による自動レビュー

PRを作成すると、自動的にAIレビューワークフローが実行されます。

**ワークフロー**: `.github/workflows/ai_review.yml`

**手動トリガー**:
1. GitHubリポジトリの「Actions」タブを開く
2. 「AI Review」ワークフローを選択
3. 「Run workflow」をクリック

#### ローカルでPRレビューを実行

```bash
bash scripts/ai_review/generate_pr.sh
```

**処理内容:**
1. `dev` ブランチとの差分を取得
2. 差分をAIに渡してレビュー
3. レビュー結果を `logs/ai_review/` に保存

> **注意**: 現状は単にPRの差分をAIに渡しているだけで、複雑な分析は行っていません。将来的に改善予定です。

---

## 🔧 GitHub Copilot 設定のカスタマイズ

### エージェントのカスタマイズ

#### 1. テンプレートの編集

`.github_copilot_template/` 配下でエージェント定義を編集：

```
.github_copilot_template/
└── coder/
    └── script/
        ├── .agent.md           # エージェント定義
        └── custom.prompt.md    # カスタムプロンプト
```

#### 2. エージェントのデプロイ

```bash
uv run python scripts/github_copilot/template_handle/deploy_agents.py
```

これにより、`.github/agents/` に反映されます。

### エージェント定義の書き方

**フロントマター**:
```yaml
---
description: スクリプト生成専門エージェント
tools: ['edit', 'search', 'runCommands']
outputs:
  - name: default
  - name: debug
    variables:
      log_level: DEBUG
---
```

**本文**:
```markdown
# Role
あなたはPythonスクリプトの生成とリファクタリングを専門とするエージェントです。

# Constraints
- PEP 8に準拠すること
- 型ヒントを必ず付けること
- docstringを記述すること

# Workflow
1. 要件をヒアリング
2. スクリプトの設計を提案
3. 実装・テストコードの生成
4. レビューとリファクタリング
```

詳細は以下のドキュメントを参照：
- [../tech_knowledge/github_copilot/エージェント設定.md](../tech_knowledge/github_copilot/エージェント設定.md)（存在する場合）
- 旧ドキュメント（参考用）: `GithubCopilot設定ファイル.md`（このファイル整理後に削除予定）

---

## 🚀 自動化ワークフロー

### GitHub Actions ワークフロー

`.github/workflows/` に定義されているワークフロー：

| ワークフロー | トリガー | 実行内容 |
|------------|---------|---------|
| **AI Review** | PR作成/更新、手動 | AIによるコードレビュー |
| **Tests** | Push、PR | pytest実行 |
| **Lint** | Push、PR | ruff/mypyによるチェック |

### ワークフローの確認

```bash
# ワークフローファイルの一覧
ls -la .github/workflows/

# ワークフローのログを確認（GitHub CLI使用）
gh run list
gh run view <run-id>
```

---

## 💡 AI活用のベストプラクティス

### 1. コンテキストを限定する

大規模なコードベースでは、フォルダやモジュール単位でコンテキストを限定すると精度が向上します。

**悪い例**:
```
プロジェクト全体をレビューしてください
```

**良い例**:
```
src/llm/claude_custom/ モジュールのみをレビューしてください。
APIキーの管理とエラーハンドリングに焦点を当ててください。
```

### 2. 具体的な観点を指定する

レビュー観点を明確にすることで、より有用なフィードバックが得られます。

**観点の例**:
- セキュリティ: APIキー、SQL injection、XSS
- パフォーマンス: ループ処理、データベースクエリ
- 可読性: 変数名、コメント、関数の分割
- 保守性: DRY原則、SOLID原則

### 3. 段階的にレビューを実施

1. **構造レビュー**: アーキテクチャ、モジュール分割
2. **機能レビュー**: ロジック、エッジケース
3. **品質レビュー**: コーディング規約、テスト
4. **最適化レビュー**: パフォーマンス、セキュリティ

### 4. レビュー結果を活用する

レビュー結果をドキュメント化し、チームで共有：

```bash
# レビュー結果を保存
logs/copilot_review/
├── llm_review_20251130.md
├── ml_review_20251130.md
└── server_review_20251130.md
```

定期的にレビュー結果を集約し、共通の問題点を改善：
- 頻出する指摘事項を開発規約に追加
- pre-commitフックで自動チェック化
- ドキュメント・コメントの充実化

---

## 🔄 継続的改善

### レビューサイクル

```
コード実装
    ↓
ローカルでAIレビュー
    ↓
修正・リファクタリング
    ↓
PR作成
    ↓
CI/CD & AIレビュー
    ↓
マージ
    ↓
定期的な全体レビュー
```

### メトリクスの追跡

レビューの効果を測定：
- レビュー指摘事項の件数推移
- バグ発見率
- コードカバレッジの向上
- 技術的負債の削減

---

## 📚 関連ドキュメント

- **スクリプト活用**: [04_スクリプト・ツール活用.md](./04_スクリプト・ツール活用.md)
- **開発規約**: [../dev_contract/INDEX.md](../dev_contract/INDEX.md)
- **Git運用**: [../dev_contract/06_Git運用.md](../dev_contract/06_Git運用.md)

---

## 🐛 トラブルシューティング

### Copilot が反応しない

1. **ネットワーク接続を確認**
2. **Copilot拡張機能を再起動**
   - VSCode: `Cmd+Shift+P` → `Developer: Reload Window`
3. **Copilotのログを確認**
   - VSCode: 出力パネル → "GitHub Copilot" を選択

### エージェントが見つからない

```bash
# エージェントファイルの存在確認
ls -la .github/agents/

# デプロイスクリプトを再実行
uv run python scripts/github_copilot/template_handle/deploy_agents.py
```

### レビュー結果が保存されない

```bash
# ログディレクトリの作成
mkdir -p logs/copilot_review/

# 権限の確認
ls -la logs/
```

---

## 🎯 まとめ

GitHub Copilotとその周辺ツールを活用することで：
- **開発効率向上**: コード生成、リファクタリング支援
- **品質向上**: 継続的なAIレビュー
- **学習促進**: AIからのフィードバックによるスキル向上
- **ドキュメント充実**: ドキュメント生成支援

積極的に活用して、より良いコードベースを構築していきましょう！
