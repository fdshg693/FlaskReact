name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai_review:
    runs-on: ubuntu-latest
    steps:
      # 1) ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2) ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—
      - name: Generate diff
        run: |
          BASE=${{ github.event.pull_request.base.ref }}
          git fetch origin $BASE
          git diff origin/$BASE...HEAD --unified=0 > diff.patch

      # 3) AI ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼
      - name: AI Review via OpenAI
        id: ai_review
        shell: bash
        run: |
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦
          PROMPT="ä»¥ä¸‹ã®å·®åˆ†ã‚’èª­ã¿å–ã‚Šã€å•é¡Œç‚¹ãƒ»æ”¹å–„æ¡ˆã‚’æ—¥æœ¬èªã§ç®‡æ¡æ›¸ãã«ã—ã¦ãã ã•ã„ã€‚\n\n\`\`\`diff\n$(cat diff.patch)\n\`\`\`"
          # API ã‚³ãƒ¼ãƒ«
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d '{
              "model": "gpt-4o-mini",
              "messages": [{"role": "user","content": '"'"$PROMPT"'"'}],
              "max_tokens": 800
            }' \
          | jq -r '.choices[0].message.content')
          # çµæœã‚’å‡ºåŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚»ãƒƒãƒˆ
          echo "::set-output name=review::$RESPONSE"

      # 4) PR ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
      - name: Post review as PR comment
        uses: actions/github-script@v6
        with:
          script: |
            const review = `**ğŸ¤– AI Code Review**\n\n${{ steps.ai_review.outputs.review }}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: review
            });
