name: AI Code Review

on: [workflow_dispatch]

jobs:
  ai_review:
    runs-on: ubuntu-latest
    steps:
      # 1) コードをチェックアウト
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2) ベースブランチとの差分を取得
      - name: Generate diff
        run: |
          BASE=${{ github.event.pull_request.base.ref }}
          git fetch origin $BASE
          git diff origin/$BASE...HEAD --unified=0 > diff.patch

      # 3) AI にレビューを依頼
      - name: AI Review via OpenAI
        id: ai_review
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # assemble the prompt
          PROMPT=$(printf '以下の差分を読み取り、問題点・改善案を日本語で箇条書きにしてください。\n\n```diff\n%s\n```' \
            "$(cat diff.patch)")

          # build a well-quoted JSON payload
          PAYLOAD=$(
            jq -n \
              --arg model "gpt-4o-mini" \
              --arg prompt "$PROMPT" \
              --argjson max_tokens 800 \
              '{model: $model, messages: [{role: "user", content: $prompt}], max_tokens: $max_tokens}'
          )

          # call OpenAI
          RESPONSE=$(
            curl -s https://api.openai.com/v1/chat/completions \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
            | jq -r '.choices[0].message.content'
          )

          # write to GITHUB_OUTPUT (set-output is deprecated)
          echo "review<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE"     >> "$GITHUB_OUTPUT"
          echo "EOF"          >> "$GITHUB_OUTPUT"
